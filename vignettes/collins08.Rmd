---
title: "Rank shifts between species"
author: "Lauren M. Hallett"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: biblio.bib
vignette: >
  %\VignetteIndexEntry{Rank shifts between species}
  %\VignetteEngine{knitr::rmarkdown}
  %\SweaveUTF8 
  %\VignetteEncoding{UTF-8}
  %\usepackage[utf8]{inputenc}
---

## Species rank orders often reshuffle over time

Species communities are temporally dynamic due to environmental drivers leading to reordering of species abundances over time. Quantifying within-community reordering is a means of evaluating community stability without masking informative temporal shifts in internal dynamics [@Collins2008]. 

## Rank clocks: visualizing species rank shifts

Rank clocks plot the rank order of abundance of each species over time in a circle (like a clock!), starting with a vertical axis at 12 o'clock. They are useful to visualize the degree to which species fluctuate over time [@Collins2008]. 

To illustrate, let's first generate some sample data:

```{r}
library(devtools)
#load_all()
library(codyn)
library(ggplot2)
library(reshape2)

## Generate some sample data 
x = 1977:2003
sp1 = .3*sin(x) + rnorm(length(x), 0, .1) + -.05*x + 150
sp2 = .2*sin(x) + rnorm(length(x), 0, .1) + -.01*x + 70
sp3 = .2*sin(x) + rnorm(length(x), 0, .1) + .01*x + 30

## Reshape the data: year, variable (y1,y2,y3), value
dat = melt(data.frame(x, sp1, sp2, sp3), "x")
```


A traditional, linear depiction of species rank shifts can be cluttered and visually confusing:
```{r, fig.width = 5, fig.height = 5}
ggplot(dat, aes(x,value,color=variable)) + geom_line(size = 2)
```


In contrast, a rank clock visualization highlights differences in the stability of species:
```{r, fig.width = 5, fig.height = 5}
ggplot(dat, aes(x, value, color=variable)) + geom_line(size = 2) + coord_polar() + theme_bw() 
```

For example, in the Konza grasslands there has been tremendous variation in the abundance of little bluestem and big bluestem over time.
```{r, fig.width = 7, fig.height = 7}
dat.agg <- aggregate(abundance ~ species * year, data = knz_001d, FUN = mean)
blues <- subset(dat.agg, species == "andropogon gerardii" | species == "schizachyrium scoparium")
ggplot(blues, aes(year, abundance, color = species)) + 
  geom_line(size = 2) + coord_polar() + theme_bw() + 
  ggtitle("Variation in little and big bluestem")
```

## rankshifts: A function to quantify shifts in species rank order

This function quantifies relative changes in species rank abundances by taking the sum difference of species ranks of consecutive pairs of years. 


## Visualizing mean species rank shifts

```{r, fig.width = 5, fig.height = 5}
##reading in data from Konza
data(collins08)

##running mean rank shift function 
dat <- meanrankshift(df=collins08, replicate.var="replicate", time.var="year", species.var="species", abundance.var="abundance")
dat$year<-as.numeric(substr(dat$year_pair, 6,9))

##plotting
ggplot(dat, aes(year, MRS, color=replicate)) + geom_line() + theme_bw()

  
```

## Citations
