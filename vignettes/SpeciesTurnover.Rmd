---
title: "Temporal Diversity Indices"
author: "Lauren M. Hallett"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: biblio.bib
vignette: >
  %\VignetteIndexEntry{Temporal diversity indices}
  %\VignetteEngine{knitr::rmarkdown}
  %\SweaveUTF8
  %\VignetteEncoding{UTF-8}
  %\usepackage[utf8]{inputenc}
  
  
---

# Overview
Many measures of community structure, such as diversity indices and rank-abundance curves, represent "snapshots in time" - which do not capture the temporal dynamics of ecological systems. For example, species richness (i.e., the number of species present) is a common metric to characterize ecological communities. However, species richness may be a poor indicator of community change if there is turnover in the identity but not the number of species present over time [@Collins2008; @cleland2013]. Similarly, species rank abundances can reorder through time, even when the pool of species present remains relatively stable. Within-year rank abundance curves fail to capture this dynamic, and other tools are needed to quantify within-community reordering without masking informative temporal shifts in internal dynamics [@Collins2008]. `codyn` includes three functions to characterize temporal shifts in species identity and rank abundances over time:

- **`turnover`** calculates total turnover as well as the proportion of species that either appear or disappear between timepoints.

- **`mean_rank_shift`** quantifies relative changes in species rank abundances by taking the sum difference of species ranks in consecutive timepoints. 
This metric goes hand-in-hand "rank clocks," a useful visualization tool of shifts in species ranks. 

- **`rate_change`** analyzes differences in species composition between samples at increasing time lags. It reflects the rate of directional change in community composition. 


```{r echo=FALSE}
library(knitr)
```

# Example dataset
`codyn` utilizes a subset of the data presented by Collins et al. [-@Collins2008]. The `collins08` dataset includes plant composition from the Konza Prairie Long-term Ecological Research site in Manhattan, KS. It spans 18 years and includes data collected from two locations, one that is annually burned and one that is unburned. 

```{r echo=FALSE}
library(codyn)
data(collins08)
kable(head(collins08))
```

# Species turnover
Species turnover represents a temporal analog to species richness. It is described by the total turnover in species (appearances and disappearances) as well as the proportion of species that either appear or disappear between time points [@Collins2008; @cleland2013]. 

## Total turnover
The function `turnover` calculates three metrics of species turnover: total turnover, appearances, and disappearances.

The default metric `total` refers to total turnover, which calculates the proportion of species that differ between timepoints as:

$$ Total\; turnover = \frac{Species\; gained\; +\; Species\; lost}{Total\; species\; observed\; in\; both\; timepoints} $$

The metric was introduced by MacArthur and Wilson (1963) and modified by Diamond (1969) to be expressed as a proportion in order to compare turnover between sites that differ in species richness.

`turnover` requires a data frame with columns for species, year and abundance, and includes an optional argument to specify a column for spatial replicates.
```{r results='asis'}
KNZ_turnover<-turnover(df=collins08, 
                       time.var="year", 
                       species.var="species", 
                       abundance.var="abundance", 
                       replicate.var="replicate")
```
```{r echo=FALSE}
    kable(head(KNZ_turnover))
```

Note that if the `replicate.var` column is not specified but the dataset in fact includes replicates, `turnover` will calculate across all species present in a given time point (i.e., it will return a site-level measure of turnover). For example, defaulting the `replicate.var` to `NA` while using the entire `collins08` dataset yields total turnover across the unburned and burned locations combined. A warning will be generated to indicate that the metric was calculated across multiple replicates.

```{r results='asis'}
KNZ_turnover_agg<-turnover(df=collins08, 
                          species.var="species",
                          time.var="year",
                          abundance.var="abundance",
                          replicate.var=NA)
```
```{r echo=FALSE}
    kable(head(KNZ_turnover_agg))
```

## Appearances and disappearances

Total turnover incorporates both species appearances and disappearances, but sometimes it is useful to parse their relative contribution. For example, a timepoint in which many species appear may reflect a different ecological story than a timepoint in which many species drop from the system, but the total turnover in both scenarios may be similar. 

Specifying `metric="appearance"` will return the proportion of species that appeared relative to the total number of species observed in both timepoints. As before, spatial replicates can be specified with the `replicate` argument; setting `replicate.var=NA` will calculate across the full dataset.
```{r results='asis'}
KNZ_appearance<-turnover(df=collins08, 
                         replicate.var="replicate",
                         metric="appearance")
```


Similarly, specifying `metric="disappearance"` will return the proportion of species that disappeared relative to the total number of species observed in both timepoints. 
```{r results='asis'}
KNZ_disappearance<-turnover(df=collins08,
                            replicate.var="replicate",
                            metric="disappearance")
```

## Turnover at Konza
Total turnover indicates that in general there were greater fluctuations in the species present in the unburned than burned location at Konza.

```{r fig.width = 7, fig.height = 4, echo=FALSE}
library(ggplot2)
ggplot(KNZ_turnover, aes(x=year, y=total, color=replicate)) + geom_line(size = 2) + theme_bw()
```

Parsing total turnover by appearances and disappearances indicates that in there were generally more appearances in the unburned than burned location. In addition, the strong divergence in total turnover between locations in 1995 was because the unburned location lost many species that year, while the burned locations lost none.

```{r echo=FALSE}
ggplot(KNZ_appearance, aes(x=year, y=appearance, color=replicate)) + geom_line(size = 2)+ theme_bw() + theme(legend.position="none")
ggplot(KNZ_disappearance, aes(x=year, y=disappearance, color=replicate)) + geom_line(size = 2)+ theme_bw() + theme(legend.position="none")
```


# Species rank shifts

## Rank clocks: visualizing species rank shifts
Rank clocks are a useful way to visualize the degree to which species reorder over time. They plot the rank order of abundance of each species over time in a circle, starting with a vertical axis at 12 o'clock [@Collins2008]. 

To illustrate, generate some sample data:

```{r}

## Generate some sample data 
yr = 1977:2003
sp1 = .3*sin(yr) + rnorm(length(yr), 0, .1) + -.05*yr + 150
sp2 = .2*sin(yr) + rnorm(length(yr), 0, .1) + -.01*yr + 70
sp3 = .2*sin(yr) + rnorm(length(yr), 0, .1) + .01*yr + 30

dat = data.frame(year = rep(yr, 3), 
           species = gl(3, length(yr), labels = c("sp1","sp2","sp3")),
           abundance = c(sp1, sp2, sp3))
```

A traditional, linear depiction of species rank shifts can be cluttered and visually confusing:
```{r, fig.width = 7, fig.height = 4}
ggplot(dat, aes(year, abundance, color = species)) + 
  geom_line(size = 2) + theme_bw()
```


In contrast, a rank clock visualization highlights differences in the stability of species:
```{r, fig.width = 5, fig.height = 5}
ggplot(dat, aes(year, abundance, color = species)) + 
  geom_line(size = 2) + coord_polar() + theme_bw() 
```


## Rank clocks at Konza

Rank clocks highlight that in the Konza grasslands there has been tremendous variation in the abundance of little bluestem and big bluestem over time.
```{r, fig.width = 7, fig.height = 5}

aggdat <- aggregate(abundance ~ species * year * replicate, 
                    data = subset(collins08, species == "andrgera" | species == "andrscop"), 
                    FUN = mean)

ggplot(aggdat, aes(year, abundance, color = species)) + 
  geom_line(size = 2) + coord_polar() + theme_bw() + facet_wrap(~replicate) +
  ggtitle("Little Bluestem and Big Bluestem \n Annually burned vs unburned plots, Konza")
```

## Mean rank shifts

The `mean_rank_shift` function describes relative changes in species rank abundances, which indicate the degree of species reording over time. This metric is calculated as:

$$ MRS = {\sum_{i=1}^{N} (|R_i,t+1 - R_i,t|})/N $$

where $N$ is the number of species in common in both years, $t$ is the year, $R_i,t$ is the relative rank of species $i$ in year $t$.

`mean_rank_shift` requires a data frame with columns for species, year and abundance, and includes an optional argument to specify a column for spatial replicates.

```{r}
KNZ_rankshift <- mean_rank_shift(df=collins08, replicate.var="replicate", abundance.var="abundance")
#Select the final year from the returned year_pair
KNZ_rankshift$year <- as.numeric(substr(KNZ_rankshift$year_pair, 6,9))
```
```{r echo=FALSE}
kable(head(KNZ_rankshift))
```

If`replicate.var=NA` but the dataset in fact includes replicates, `mean_rank_shift` will be calculated using all species present in the datset. For collins08, this would return mean_rank_shift for the burned and unburned areas combined. A warning will be generated to indicate that the metric was calculated across multiple replicates.
```{r}
KNZ_rankshift_agg <- mean_rank_shift(df=collins08, replicate.var=NA)
#Select the final year from the returned year_pair
KNZ_rankshift$year<-as.numeric(substr(KNZ_rankshift$year_pair, 6, 9))
```

## Rank shifts at Konza
Calculating mean rank shifts highlights the stability of communities diverged at Konza around 1992, with fewer rank shifts between species in the burned relative to the unburned area. 
```{r fig.width = 7, fig.height = 4,}
##plotting
ggplot(KNZ_rankshift, aes(year, MRS, color=replicate)) + 
  geom_line(size= 2) + theme_bw() + theme(legend.position="none")
```


## Citations


