---
title: "Community stability and species asynchrony"
author: ""
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: biblio.bib
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

## Overview
Ecologists have long debated the relationship between species diversity and stability. One key question in this debate is how the individual components of a community (e.g., species in species-rich communities) affect the stability of aggregate properties of the whole community (e.g., biomass production). For example, even unstable species populations may maintain stable community productivity if a decrease in one species is compensated by an increase in another. Analyzing time-series data of species composition is an increasingly common way to test whether species asynchrony may increase community stability. Methods to characterize species asynchrony have been highly debated. codyn includes a function to characterize community stability, `community_stability`, and three metrics to characterize species asynchrony:

`variance_ratio` which compares the variance of the community as a whole relative to the sum of the individual population variances (Schluter 1984, Houlahan et al. 2007), and includes a null-modeling approach to test signficance (Hallett et al. 2014).

`synchrony` which compares the variance of the community-level property with the variance of individual components (Loreau and de Mazancourt 2008)

`GROSS et al 2014 METRIC` which compares the average correlation of each individual species with the rest of the aggregated community (Gross et al. 2014)


```{r message=FALSE}
library(codyn)
library(knitr)
library(dplyr)
```

##Data 
To illustrate each function, we will use a grassland species composition data from the Konza Prairie Long-term Ecological Research site in Manhattan, KS. The KNZ dataset spans 24 years and includes 20 replicate subplots.

```{r results='asis'}
KNZ <- read.csv(system.file("extdata", "knz_001d.csv", package="codyn"), sep=",", header=TRUE)
kable(head(KNZ))
```


##Community stability
The `community_stability` function aggregates species abundances within replicate and year, and used these values to calculate community stability as µ/σ (i.e.,the inverse of the coefficient of variation, Tilman 1999). It includes an argument to calculate community stabilty across multiple replicates:


```{r results='asis'}
KNZ_stability<-community_stability(KNZ, replicate="subplot", year="year", abundance="abundance")
kable(head(KNZ_stability))
```

If the replicate argument is equal to NA, the function will aggregate all values within a year and return an integer value.
```{r results='asis'}
KNZ_A1<-subset(KNZ, subplot=="A_1")
KNZ_A1_stability<-community_stability(KNZ_A1, replicate=NA, year="year", abundance="abundance")
KNZ_A1_stability
```



## The Variance Ratio

Community variance of total biomass will be

$$ Var(x_1 + x_2 + \dotsb + x_N)  = \sum_{i = 1}^{N} Var(x_i) + 2\left(\sum_{i = 1}^{N - 1} \sum_{j = i + 1}^{N} Covar(x_i, x_j)\right)$$ 

Which gives us the covariance ratio:

$$ vr = \frac{var\left(\sum_{i}^{N} x_i \right)}{\sum_{i}^{N} var(x_i)} $$

The variance ratio measures the amount of covariance between species.  If species are overall uncorrelated (i.e. $Covar(x_i, x_j) = 0$) then the ratio's value will be close to 1. If species have a negative covariance then the ratio will be < 1, and if species have a positive covariance then it's value is > 1.

## Caluculating the variance ratio
We have a function for calculating the variance ratio:

```{r results='asis', eval=FALSE}
myresults<-varianceratio(knz_001d, "subplot", "species", "year", "abundance", 1)
kable(myresults)
```

## Testing Variance ratios against a null distribution

Calculating the $vr$ as above is all very well -- but what does it mean? A certain amount of variability in populations is expected, and will cause the covariances of independent species to vary from 0 by chance alone.  How much does this stochastiticy influence the variance ratio? We need a null model for species variation over time:

There are several null models in the literature

### Torus 

### Phase scrambling


We have a nice function for transforming a long dataframe into a matrix of year x species

```{r results='asis', eval=FALSE}
one_matrix <- knz_001d %>%
  filter(subplot == "A_1") %>%
  select(-subplot) %>%
  codyn:::calComDat("species", "year", "abundance")

kable(one_matrix[1:5, 1:5])
```

We also need to do this for time series.

```{r, eval=FALSE}
one_ts <- knz_001d %>%
  filter(subplot == "A_1") %>%
  select(-subplot) %>%
  codyn:::calComTS("species", "year", "abundance")

kable(one_ts[1:5, 1:5])
```


Hm. what else might be returned by  `varianceratio`? a list which also includes the null simulations?

I think we should export the `varianceratio` test too

## Figures from Grman et al. 2010




## citations


